<!DOCTYPE html>
<head>
  <title>Object detection</title>
  <style>
    canvas {
      border: 2px solid;
    }
  </style>
  <script>
    var canvas = null;

    var SIZE = 300;
    var INTERVAL = 42;
    var THRESHOLD = 110;

    var OBJECT_PROP = null;
    var OBSERVATIONS = [];
    var OBS_COUNT = 0;

    function main() {
      canvas = document.getElementById("camera");
      canvas.width = SIZE;
      canvas.height = SIZE;

      const constraints = {
        video: true,
      };
      const permission = navigator.mediaDevices
        .getUserMedia(constraints)
        .then((stream) => {
          const video = document.createElement("video");
          video.srcObject = stream;
          video.play();
          setInterval(updateImage, INTERVAL, video);
        })
        .catch((error) => {
          console.error(error);
          alert("camera permission denied");
        });
    }

    function updateImage(video) {
      const ctx = canvas.getContext("2d", { willReadFrequently: true });

      const minSize = Math.min(video.videoWidth, video.videoHeight);
      const startX = (video.videoWidth - minSize) / 2;
      const startY = (video.videoHeight - minSize) / 2;

      ctx.drawImage(video, startX, startY, minSize, minSize, 0, 0, SIZE, SIZE);

      const image = ctx.getImageData(0, 0, SIZE, SIZE);
      const matrix = getPixelMatrix(image.data);

      processMatrix(matrix);
    }

    function getPixelMatrix(dataArray) {
      const matrix = [];
      for (let i = 1; i <= SIZE; i++) {
        matrix[i] = [];
        for (let j = 1; j <= SIZE; j++) {
          const groupIdx = (i - 1) * SIZE * 4 + (j - 1) * 4;
          const R = dataArray[groupIdx];
          const G = dataArray[groupIdx + 1];
          const B = dataArray[groupIdx + 2];
          // const A = dataArray[groupIdx + 3];
          matrix[i][j] = (R + G + B) / 3;
        }
      }

      return matrix;
    }

    function processMatrix(matrix) {
      isolateObject(matrix);
      const box = getBoundingBox(matrix);
      const boxProp = getBoxProperty(box);

      OBJECT_PROP = boxProp.aspectRatio;
      document.getElementById(
        "output"
      ).innerHTML = `Aspect ratio: ${OBJECT_PROP.toFixed(2)}`;

      updateCanvas(matrix);
      drawBox(box);
    }

    function isolateObject(matrix) {
      for (let i = 1; i <= SIZE; i++) {
        for (let j = 1; j <= SIZE; j++) {
          if (matrix[i][j] < THRESHOLD) {
            matrix[i][j] = 0;
          } else {
            matrix[i][j] = 255;
          }
        }
      }
    }

    function drawBox(box) {
      const ctx = canvas.getContext("2d", { willReadFrequently: true });

      ctx.beginPath();
      ctx.lineWidth = 2;
      ctx.strokeStyle = "pink";
      const dx = box.xMax - box.xMin;
      const dy = box.yMax - box.yMin;
      ctx.rect(box.xMin, box.yMin, dx, dy);
      ctx.stroke();
    }

    function getBoundingBox(matrix) {
      const box = {
        xMin: SIZE + 1,
        xMax: 0,
        yMin: SIZE + 1,
        yMax: 0,
      };

      for (let y = 1; y <= SIZE; y++) {
        for (let x = 1; x <= SIZE; x++) {
          if (matrix[y][x] === 0) {
            box.yMin = Math.min(box.yMin, y);
            box.yMax = Math.max(box.yMax, y);
            box.xMin = Math.min(box.xMin, x);
            box.xMax = Math.max(box.xMax, x);
          }
        }
      }

      return box;
    }

    function getBoxProperty(box) {
      const prop = {
        length: 0,
        width: 0,
        aspectRatio: 0,
      };

      const dx = box.xMax - box.xMin + 1;
      const dy = box.yMax - box.yMin + 1;

      // 길이가 긴 쪽이 length, 짧은쪽이 width
      prop.length = Math.max(dx, dy);
      prop.width = Math.min(dx, dy);
      prop.aspectRatio = prop.width / prop.length;

      return prop;
    }

    function updateCanvas(matrix) {
      const ctx = canvas.getContext("2d", { willReadFrequently: true });
      const image = ctx.getImageData(0, 0, SIZE, SIZE);

      for (let i = 1; i <= SIZE; i++) {
        for (let j = 1; j <= SIZE; j++) {
          const groupIdx = ((i - 1) * SIZE + (j - 1)) * 4;
          const val = matrix[i][j];
          image.data[groupIdx] = val;
          image.data[groupIdx + 1] = val;
          image.data[groupIdx + 2] = val;
        }
      }

      ctx.putImageData(image, 0, 0);
    }

    function learn() {
      const name = document.getElementById("objectName").value;
      if (!name) {
        alert("Please enter the object name");
        return;
      }

      OBS_COUNT++;
      OBSERVATIONS[OBS_COUNT] = {
        name: name,
        prop: OBJECT_PROP,
      };

      document.getElementById("objectName").value = "";
    }

    function checkKeyPress(event) {
      if (event.key == "Enter") {
        learn();
      }
    }
  </script>
</head>
<body onload="main()">
  <main>
    <canvas id="camera"></canvas>
    <div id="output">?</div>
    <br />
    <input
      id="objectName"
      onkeyup="checkKeyPress(event)"
      placeholder="what's this?"
    />
    <button class="button" onclick="learn()">Learn</button>
  </main>
</body>
