<!DOCTYPE html>
<head>
  <title>Object detection</title>
  <style>
    canvas {
      border: 2px solid;
    }
  </style>
  <script>
    var canvas = null;

    var SIZE = 300;
    var INTERVAL = 42;
    var THRESHOLD = 130;

    function main() {
      canvas = document.getElementById("camera");
      canvas.width = SIZE;
      canvas.height = SIZE;

      const constraints = {
        video: true,
      };
      const permission = navigator.mediaDevices
        .getUserMedia(constraints)
        .then((stream) => {
          const video = document.createElement("video");
          video.srcObject = stream;
          video.play();
          setInterval(updateImage, INTERVAL, video);
        })
        .catch((error) => {
          console.error(error);
          alert("camera permission denied");
        });
    }

    function updateImage(video) {
      const ctx = canvas.getContext("2d");

      const minSize = Math.min(video.videoWidth, video.videoHeight);
      const startX = (video.videoWidth - minSize) / 2;
      const startY = (video.videoHeight - minSize) / 2;

      ctx.drawImage(video, startX, startY, minSize, minSize, 0, 0, SIZE, SIZE);

      const image = ctx.getImageData(0, 0, SIZE, SIZE);
      const matrix = getPixelMatrix(image.data);

      processMatrix(matrix);
    }

    function getPixelMatrix(dataArray) {
      const matrix = [];
      for (let i = 1; i <= SIZE; i++) {
        matrix[i] = [];
        for (let j = 1; j <= SIZE; j++) {
          const groupIdx = (i - 1) * SIZE * 4 + (j - 1) * 4;
          const R = dataArray[groupIdx];
          const G = dataArray[groupIdx + 1];
          const B = dataArray[groupIdx + 2];
          // const A = dataArray[groupIdx + 3];
          matrix[i][j] = (R + G + B) / 3;
        }
      }

      return matrix;
    }

    function processMatrix(matrix) {
      isolateObject(matrix);
      updateCanvas(matrix);
    }

    function isolateObject(matrix) {
      for (let i = 1; i <= SIZE; i++) {
        for (let j = 1; j <= SIZE; j++) {
          if (matrix[i][j] < THRESHOLD) {
            matrix[i][j] = 0;
          } else {
            matrix[i][j] = 255;
          }
        }
      }
    }

    function updateCanvas(matrix) {
      const ctx = canvas.getContext("2d");
      const image = ctx.getImageData(0, 0, SIZE, SIZE);

      for (let i = 1; i <= SIZE; i++) {
        for (let j = 1; j <= SIZE; j++) {
          const groupIdx = ((i - 1) * SIZE + (j - 1)) * 4;
          const val = matrix[i][j];
          image.data[groupIdx] = val;
          image.data[groupIdx + 1] = val;
          image.data[groupIdx + 2] = val;
        }
      }

      ctx.putImageData(image, 0, 0);
    }
  </script>
</head>
<body onload="main()">
  <main>
    <canvas id="camera"></canvas>
    <div id="output">?</div>
    <br />
    <input id="objectName" placeholder="what's this?" />
    <button class="button">Learn</button>
  </main>
</body>
